<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<meta name="keywords" content="api-boot-rate-limiter" />
	<meta name="description" content="api-boot-rate-limiter" />
	<!-- 网页标签标题 -->
	<title>ApiBoot Rate Limiter 使用文档</title>
	<link rel="shortcut icon" href="/img/favicon.ico" />
	<link rel="stylesheet" href="/build/documentation.css" />
</head>

<body>
	<div id="root"><div class="documentation-page" data-reactroot=""><header class="header-container header-container-normal"><div class="header-body"><a href="/zh-cn/index.html"><img class="logo" src="/img/apiboot-colorful.png"/></a><div class="search search-normal"><span class="icon-search"></span></div><span class="language-switch language-switch-normal">En</span><div class="header-menu"><img class="header-menu-toggle" src="/img/system/menu_gray.png"/><ul><li class="menu-item menu-item-normal"><a href="/zh-cn/index.html" target="_self">首页</a></li><li class="menu-item menu-item-normal menu-item-normal-active"><a href="/zh-cn/docs/quick-start.html" target="_self">文档</a></li></ul></div></div></header><div class="bar"><div class="bar-body"><img src="/img/system/docs.png" class="front-img"/><span>ApiBoot 文档</span><img src="/img/system/docs.png" class="back-img"/></div></div><section class="content-section"><div class="sidemenu"><div class="sidemenu-toggle"><img src="https://img.alicdn.com/tfs/TB1E6apXHGYBuNjy0FoXXciBFXa-200-200.png"/></div><ul><li class="menu-item menu-item-level-1"><span>ApiBoot</span><ul><li style="height:144px;overflow:hidden" class="menu-item menu-item-level-2"><span>ApiBoot是什么？<img style="transform:rotate(0deg)" class="menu-toggle" src="/img/system/arrow_down.png"/></span><ul><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/introduce.html" target="_self">ApiBoot简介</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/faq.html" target="_self">FAQ</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/update-log.html" target="_self">更新日志</a></li></ul></li><li style="height:648px;overflow:hidden" class="menu-item menu-item-level-2"><span>快速开始<img style="transform:rotate(0deg)" class="menu-toggle" src="/img/system/arrow_down.png"/></span><ul><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/quick-start.html" target="_self">第一个ApiBoot应用程序</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/version-rely.html" target="_self">版本依赖</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/api-boot-security.html" target="_self">ApiBoot Security</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/api-boot-oauth.html" target="_self">ApiBoot OAuth</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/api-boot-swagger.html" target="_self">ApiBoot Swagger</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/api-boot-quartz.html" target="_self">ApiBoot Quartz</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/api-boot-rate-limiter.html" target="_self">ApiBoot RateLimiter</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/api-boot-datasource-switch.html" target="_self">ApiBoot DataSource Switch</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/api-boot-mybatis-enhance.html" target="_self">ApiBoot Mybatis Enhance</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/api-boot-mybatis-enhance-codegen.html" target="_self">ApiBoot Mybatis Enhance Codegen</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/api-boot-mybatis-pageable.html" target="_self">ApiBoot Mybatis Pageable</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/api-boot-resource-load.html" target="_self">ApiBoot Resource Load</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/api-boot-message-push.html" target="_self">ApiBoot Message Push</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/api-boot-http-message-converter.html" target="_self">ApiBoot HttpMessage Converter</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/api-boot-oss.html" target="_self">ApiBoot AliYun OSS</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/api-boot-mail.html" target="_self">ApiBoot AliYun Mail</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/api-boot-sms.html" target="_self">ApiBoot AliYun SMS</a></li></ul></li><li style="height:144px;overflow:hidden" class="menu-item menu-item-level-2"><span>运维指南<img style="transform:rotate(0deg)" class="menu-toggle" src="/img/system/arrow_down.png"/></span><ul><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/deploy.html" target="_self">打包部署</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/domain.html" target="_self">域名解析</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/nginx-load-balance.html" target="_self">Nginx负载均衡</a></li></ul></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><span>开源共建<img style="transform:rotate(-90deg)" class="menu-toggle" src="/img/system/arrow_down.png"/></span><ul><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/contribution.html" target="_self">贡献源码</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/conventions.html" target="_self">编码约定</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/new-starter.html" target="_self">新建组件</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/api-boot-plan.html" target="_self">ApiBoot规划</a></li></ul></li></ul></li></ul></div><div class="doc-content markdown-body"><h1>ApiBoot 实现分布式令牌桶方式限流</h1>
<p><code>ApiBoot RateLimiter</code>基于拦截器的实现，封装了<code>Google</code>的<code>令牌桶方式</code>的限流实现，可通过注解配置每个接口的流量<code>QPS</code>（每秒允许的流量请求）。</p>
<blockquote>
<p>注意：目前不支持分布式系统的流量限制，会在下个版本进行更新添加。</p>
</blockquote>
<h2>添加依赖</h2>
<pre><code class="language-xml">  <span class="hljs-comment">&lt;!--ApiBoot RateLimiter--&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.minbox.framework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>api-boot-starter-rate-limiter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<blockquote>
<p>如果对<code>ApiBoot</code>使用不了解，可查看<a href="/docs/quick-start.html">快速接入ApiBoot</a></p>
</blockquote>
<h2>相关配置</h2>
<table>
<thead>
<tr>
<th>配置名称</th>
<th>默认值</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>api.boot.rate-limiter.interceptor-url</code></td>
<td>/**</td>
<td>数组类型，可配置多个限流的路径地址</td>
</tr>
<tr>
<td><code>api.boot.rate-limiter.enable-global-qps</code></td>
<td>false</td>
<td>是否开启全局限流配置</td>
</tr>
<tr>
<td><code>api.boot.rate-limiter.global-qps</code></td>
<td>10</td>
<td>全局限流QPS</td>
</tr>
</tbody>
</table>
<h2>QPS定义</h2>
<p>限流注解<code>RateLimiter</code>配置使用如下所示：</p>
<pre><code class="language-java"><span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping</span>(value = <span class="hljs-string">"/resource"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ResourceSampleController</span> </span>{
    <span class="hljs-comment">/**
     * QPS = 10
     * 配置该接口每秒只允许访问10次
     *
     * <span class="hljs-doctag">@return</span>
     */</span>
    <span class="hljs-meta">@RequestMapping</span>(value = <span class="hljs-string">"/"</span>)
    <span class="hljs-meta">@RateLimiter</span>(QPS = <span class="hljs-number">10</span>)
    <span class="hljs-function"><span class="hljs-keyword">public</span> UserInfo <span class="hljs-title">user</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> UserInfo(<span class="hljs-string">"admin"</span>);
    }
}
</code></pre>
<h2>单服务限流</h2>
<p>对于单个服务的场景使用限流时，<code>ApiBoot RateLimiter</code>内部使用<code>Google Guava</code>采用令牌桶的方式实现，具体源码实现详见<code>GoogleGuavaRateLimiter</code>类。</p>
<blockquote>
<p>引用<code>ApiBoot RateLimiter</code>的项目如果并未添加<code>spring-boot-starter-data-redis</code>依赖，项目中并未初始化<code>RedisTemplate</code>时则会采用<code>Google Guava</code>方式来进行限流。</p>
</blockquote>
<h2>分布式服务限流</h2>
<p>如果你采用微服务、负载均衡的方式进行部署服务时，单服务限流是无法完成预期的效果的，<code>ApiBoot RateLimiter</code>内部集成了<code>Redis</code>方式来自动完成限流，使用<code>Redis</code>后期也利于扩展，如果应用程序过大也可以搭建<code>Redis 集群</code>完成限流。</p>
<p><code>ApiBoot RateLimiter</code>内部的<code>Redis</code>使用了<code>SpringCloud GateWay</code>官方用的<code>Lua</code>脚本来保证限流的原子性、线程安全性。</p>
<p>使用<code>Redis</code>方式很简单，只需要在项目中添加<code>Redis</code>依赖后进行配置后<code>ApiBoot RateLimiter</code>就会自动通过<code>RedisTemplate</code>来操作<code>Lua</code>脚本，步骤如下所示：</p>
<h4>第一步：添加Redis依赖</h4>
<pre><code class="language-xml"><span class="hljs-comment">&lt;!--Redis--&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<h4>第二步：配置Redis</h4>
<pre><code class="language-yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-comment"># redis 相关配置</span>
<span class="hljs-attr">  redis:</span>
<span class="hljs-attr">    password:</span> <span class="hljs-number">123456</span>
</code></pre>
<blockquote>
<p>如果你所使用的<code>Redis</code>有密码，这里需要进行配置，其他配置参数使用默认值。</p>
</blockquote>
<h3>测试限流</h3>
<p>当我们访问被限流的接口时，<code>ApiBoot RateLimiter</code>会自动向<code>Redis</code>写入两条数据，<code>key</code>如下所示：</p>
<pre><code class="language-java"><span class="hljs-comment">// redis key list</span>
qps_rate_limiter.{/test/}.timestamp
qps_rate_limiter.{/test/}.tokens
</code></pre>
<ul>
<li><code>qps_rate_limiter.{/test/}.timestamp</code>：存放上一次请求的时间戳</li>
<li><code>qps_rate_limiter.{/test/}.tokens</code>：存放剩余的请求令牌数量</li>
</ul>
<p><code>key</code>的格式为<code>qps_rate_limiter.{xxx}.timestamp</code>、<code>qps_rate_limiter.{xxx}.tokens</code>。</p>
<p>其中<code>xxx</code>为请求接口的路径。</p>
<p><strong>当然单服务实例也可以使用<code>Redis</code>方式</strong></p>
<h2>自定义流量溢出响应</h2>
<p>流量被限制后可以自定义响应的实体来告知请求发起端，方便做一些业务性质的处理，如下所示：</p>
<pre><code class="language-java"><span class="hljs-keyword">import</span> org.minbox.framework.api.boot.common.model.ApiBootResult;
<span class="hljs-keyword">import</span> org.minbox.framework.api.boot.plugin.rate.limiter.result.RateLimiterOverFlowResponse;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;

<span class="hljs-comment">/**
 * 自定义流量溢出后响应的实体格式
 *
 * <span class="hljs-doctag">@author</span>：恒宇少年 - 于起宇
 * &lt;p&gt;
 * DateTime：2019-05-25 16:21
 * Blog：http://blog.yuqiyu.com
 * WebSite：http://www.jianshu.com/u/092df3f77bca
 * Gitee：https://gitee.com/hengboy
 * GitHub：https://github.com/hengboy
 */</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CustomerResponse</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">RateLimiterOverFlowResponse</span> </span>{
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">overflow</span><span class="hljs-params">(Object[] methodArgs)</span> </span>{
        <span class="hljs-keyword">return</span> ApiBootResult.builder().errorCode(<span class="hljs-string">"REQUEST_OVER_FLOW"</span>).errorMessage(<span class="hljs-string">"流量被限制."</span>).build();
    }
}
</code></pre>
<blockquote>
<p><code>overflow</code>方法可返回任意类型对象。</p>
</blockquote>
<h2>配置中心支持</h2>
<p>为了保证有前瞻性突发流量的处理，<code>ApiBoot RateLimiter</code>支持了外部配置中心，在配置中心修改接口限流<code>QPS</code>后会实时更新到应用程序内。</p>
<h3>Nacos 配置中心</h3>
<p>如果你想使用<code>Nacos Config</code>作为<code>ApiBoot RateLimiter</code>的外部<code>QPS</code>配置方式，那么我们需要进行下面的步骤来完成：</p>
<h4>添加依赖</h4>
<pre><code class="language-xml"><span class="hljs-comment">&lt;!--Nacos--&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>nacos-config-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<blockquote>
<p><code>ApiBoot</code>内置了<code>Nacos Starter</code>的版本，这里无需添加版本号。</p>
</blockquote>
<h4>配置参数</h4>
<p>我们添加了<code>Nacos</code>依赖，那需要进行配置<code>Nacos Server</code>的地址，具体<code>Nacos Server</code>怎么安装，可以去看我的博客文章或者直接访问<a href="https://nacos.io/zh-cn/docs/quick-start.html">Nacos 快速开始</a></p>
<p><code>Nacos在application.yml</code>配置如下所示：</p>
<pre><code class="language-yaml"><span class="hljs-comment"># nacos config</span>
<span class="hljs-attr">nacos:</span>
<span class="hljs-attr">  config:</span>
<span class="hljs-attr">    server-addr:</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><span class="hljs-string">:8848</span>
</code></pre>
<p><code>8848</code>是<code>Nacos Server</code>的默认端口号，这里直接配置使用。</p>
<h4>测试动态修改</h4>
<p>我们在启动应用程序时，<code>ApiBoot RateLimiter</code>会自动从<code>Nacos</code>读取<code>DATA_ID</code>为<code>apiboot-rate-limiter-config</code>的配置，分组为<code>DEFAULT_GROUP</code>的<code>Properties</code>类型的配置文件，然后<strong>缓存到本地</strong>。</p>
<p>如果<code>Nacos</code>并没有该配置文件，则在<strong>第一次访问接口时自动创建</strong>。</p>
<p><img src="http://image.yuqiyu.com/apiboot/rate-limiter-nacos-config.png" alt=""></p>
<p><code>apiboot-rate-limiter-config</code>配置文件是<code>Properties</code>形式的存储的，那么<code>Key</code>的生成规则则是把请求接口地址的<code>/</code>替换为了<code>.</code>，如下所示：</p>
<pre><code class="language-properties"><span class="hljs-meta">.resource.</span>=<span class="hljs-string">50</span>
<span class="hljs-meta">.resource.detail</span>=<span class="hljs-string">10</span>
</code></pre>
<p>下面我们来测试修改配置后，<code>ApiBoot RateLimiter</code>是否可以实时生效，将<code>.resource.</code>修改为20后，控制台会打印如下日志信息：</p>
<pre><code class="language-sh">Update <span class="hljs-built_in">local</span> current RateLimiter configuration is complete，content：{.resource.=20, .resource.detail=10}
</code></pre>
<p>当我们再次访问<code>/resource/</code>接口时就会发现限流的<code>QPS</code>一秒内只允许访问<code>20</code>次。</p>
</div></section><footer class="footer-container"><div class="footer-body"><img src="/img/apiboot-gray.png"/><div class="cols-container"><div class="col col-12"><h3>愿景</h3><p>ApiBoot致力于解决快速开发接口服务、集成第三方依赖</p></div><div class="col col-6"><dl><dt>文档</dt><dd><a href="/zh-cn/docs/introduce.html" target="_self">概览</a></dd><dd><a href="/zh-cn/docs/quick-start.html" target="_self">快速开始</a></dd><dd><a href="/zh-cn/docs/faq.html" target="_self">开发者指南</a></dd></dl></div><div class="col col-6"><dl><dt>资源</dt><dd><a href="/zh-cn/blog/index.html" target="_self">博客</a></dd><dd><a href="/zh-cn/community/index.html" target="_self">社区</a></dd></dl></div></div><div class="copyright"><span>Copyright © 2019 恒宇少年 - 于起宇</span></div></div></footer></div></div>
	<script src="https://f.alicdn.com/react/15.4.1/react-with-addons.min.js"></script>
	<script src="https://f.alicdn.com/react/15.4.1/react-dom.min.js"></script>
	<script>
		window.rootPath = '';
	</script>
	<script src="/build/documentation.js"></script>
</body>

</html>
<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<meta name="keywords" content="api-boot-quartz" />
	<meta name="description" content="api-boot-quartz" />
	<!-- 网页标签标题 -->
	<title>ApiBoot Quartz 使用文档</title>
	<link rel="shortcut icon" href="/img/favicon.ico" />
	<link rel="stylesheet" href="/build/documentation.css" />
	<!-- Global site tag (gtag.js) - Google Analytics -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=UA-149679255-1"></script>
	<script>
  		window.dataLayer = window.dataLayer || [];
  		function gtag(){dataLayer.push(arguments);}
  		gtag('js', new Date());
  		gtag('config', 'UA-149679255-1');
	</script>
</head>

<body>
	<div id="root"><div class="documentation-page" data-reactroot=""><header class="header-container header-container-normal"><div class="header-body"><a href="/zh-cn/index.html"><img class="logo" src="/img/apiboot-colorful.png"/></a><div class="search search-normal"><span class="icon-search"></span></div><span class="language-switch language-switch-normal">En</span><div class="header-menu"><img class="header-menu-toggle" src="/img/system/menu_gray.png"/><ul><li class="menu-item menu-item-normal"><a href="/zh-cn/index.html" target="_self">首页</a></li><li class="menu-item menu-item-normal"><a href="http://blog.yuqiyu.com" target="_self">作者博客</a></li><li class="menu-item menu-item-normal menu-item-normal-active"><a href="/zh-cn/docs/quick-start.html" target="_self">文档</a></li></ul></div></div></header><div class="bar"><div class="bar-body"><img src="/img/system/docs.png" class="front-img"/><span>ApiBoot 文档</span><img src="/img/system/docs.png" class="back-img"/></div></div><section class="content-section"><div class="sidemenu"><div class="sidemenu-toggle"><img src="https://img.alicdn.com/tfs/TB1E6apXHGYBuNjy0FoXXciBFXa-200-200.png"/></div><ul><li class="menu-item menu-item-level-1"><span>ApiBoot</span><ul><li style="height:144px;overflow:hidden" class="menu-item menu-item-level-2"><span>ApiBoot是什么？<img style="transform:rotate(0deg)" class="menu-toggle" src="/img/system/arrow_down.png"/></span><ul><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/introduce.html" target="_self">ApiBoot简介</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/faq.html" target="_self">FAQ</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/update-log.html" target="_self">更新日志</a></li></ul></li><li style="height:288px;overflow:hidden" class="menu-item menu-item-level-2"><span>ApiBoot往期版本文档<img style="transform:rotate(0deg)" class="menu-toggle" src="/img/system/arrow_down.png"/></span><ul><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/history-reference-guide.html" target="_self">往期文档说明</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/2.1.5.RELEASE/reference-guide.html" target="_self">2.1.5.RELEASE</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/2.1.4.RELEASE/reference-guide.html" target="_self">2.1.4.RELEASE</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/2.1.3.RELEASE/reference-guide.html" target="_self">2.1.3.RELEASE</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/2.1.2.RELEASE/reference-guide.html" target="_self">2.1.2.RELEASE</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/2.1.1.RELEASE/reference-guide.html" target="_self">2.1.1.RELEASE</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/2.1.0.RELEASE/reference-guide.html" target="_self">2.1.0.RELEASE</a></li></ul></li><li style="height:756px;overflow:hidden" class="menu-item menu-item-level-2"><span>快速开始<img style="transform:rotate(0deg)" class="menu-toggle" src="/img/system/arrow_down.png"/></span><ul><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/quick-start.html" target="_self">第一个ApiBoot应用程序</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/version-rely.html" target="_self">版本依赖</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/api-boot-logging-admin-ui.html" target="_self">ApiBoot Logging Admin UI</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/api-boot-logging-admin.html" target="_self">ApiBoot Logging Admin</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/api-boot-logging.html" target="_self">ApiBoot Logging</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/api-boot-security.html" target="_self">ApiBoot Security</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/api-boot-oauth.html" target="_self">ApiBoot OAuth</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/api-boot-swagger.html" target="_self">ApiBoot Swagger</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/api-boot-quartz.html" target="_self">ApiBoot Quartz</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/api-boot-rate-limiter.html" target="_self">ApiBoot RateLimiter</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/api-boot-datasource-switch.html" target="_self">ApiBoot DataSource Switch</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/api-boot-mybatis-enhance.html" target="_self">ApiBoot Mybatis Enhance</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/api-boot-mybatis-enhance-codegen.html" target="_self">ApiBoot Mybatis Enhance Codegen</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/api-boot-mybatis-pageable.html" target="_self">ApiBoot Mybatis Pageable</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/api-boot-resource-load.html" target="_self">ApiBoot Resource Load</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/api-boot-message-push.html" target="_self">ApiBoot Message Push</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/api-boot-http-message-converter.html" target="_self">ApiBoot HttpMessage Converter</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/api-boot-oss.html" target="_self">ApiBoot AliYun OSS</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/api-boot-mail.html" target="_self">ApiBoot AliYun Mail</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/api-boot-sms.html" target="_self">ApiBoot AliYun SMS</a></li></ul></li><li style="height:144px;overflow:hidden" class="menu-item menu-item-level-2"><span>运维指南<img style="transform:rotate(0deg)" class="menu-toggle" src="/img/system/arrow_down.png"/></span><ul><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/deploy.html" target="_self">打包部署</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/domain.html" target="_self">域名解析</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/nginx-load-balance.html" target="_self">Nginx负载均衡</a></li></ul></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><span>开源共建<img style="transform:rotate(-90deg)" class="menu-toggle" src="/img/system/arrow_down.png"/></span><ul><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/contribution.html" target="_self">贡献源码</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/conventions.html" target="_self">编码约定</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/new-starter.html" target="_self">新建组件</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/api-boot-plan.html" target="_self">ApiBoot规划</a></li></ul></li></ul></li></ul></div><div class="doc-content markdown-body"><h1>ApiBoot 整合 Quartz 分布式任务调度框架</h1>
<p><code>ApiBoot</code>内部集成了<code>Quartz</code>，提供了<code>数据库方式</code>、<code>内存方式</code>的进行任务的存储，其中<code>数据库</code>方式提供了<code>分布式集群任务调度</code>，任务自动平滑切换执行节点。</p>
<h2>引用ApiBoot Quartz</h2>
<p>在<code>pom.xml</code>配置文件内添加，如下配置：</p>
<pre><code class="language-xml"><span class="hljs-comment">&lt;!--ApiBoot Quartz--&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.minbox.framework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>api-boot-starter-quartz<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<blockquote>
<p>注意：如果未添加<code>ApiBoot</code>版本依赖，请访问<a href="/zh-cn/docs/version-rely.html">版本依赖</a>查看添加方式。</p>
</blockquote>
<blockquote>
<p>备注：如果使用<code>ApiBoot Quartz</code>的内存方式，仅需要添加上面的依赖即可。</p>
</blockquote>
<h2>相关配置</h2>
<table>
<thead>
<tr>
<th>参数名称</th>
<th>是否必填</th>
<th>默认值</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>api.boot.quartz.job-store-type</code></td>
<td>否</td>
<td>memory</td>
<td>任务存储源方式，默认内存方式</td>
</tr>
<tr>
<td><code>api.boot.quartz.scheduler-name</code></td>
<td>否</td>
<td>scheduler</td>
<td>调度器名称</td>
</tr>
<tr>
<td><code>api.boot.quartz.auto-startup</code></td>
<td>否</td>
<td>true</td>
<td>初始化后是否自动启动调度程序</td>
</tr>
<tr>
<td><code>api.boot.quartz.startup-delay</code></td>
<td>否</td>
<td>0</td>
<td>初始化完成后启动调度程序的延迟。</td>
</tr>
<tr>
<td><code>api.boot.quartz.wait-for-jobs-to-complete-on-shutdown</code></td>
<td>否</td>
<td>false</td>
<td>是否等待正在运行的作业在关闭时完成。</td>
</tr>
<tr>
<td><code>api.boot.quartz.overwrite-existing-jobs</code></td>
<td>否</td>
<td>false</td>
<td>配置的作业是否应覆盖现有的作业定义。</td>
</tr>
<tr>
<td><code>api.boot.quartz.jdbc</code></td>
<td>否</td>
<td></td>
<td>配置数据库方式的Jdbc相关配置</td>
</tr>
<tr>
<td><code>api.boot.quartz.prop.job-store-class</code></td>
<td>否</td>
<td>org.quartz.impl.jdbcjobstore.JobStoreTX</td>
<td>任务数据源类</td>
</tr>
<tr>
<td><code>api.boot.quartz.prop.job-store-cluster-checkin-interval</code></td>
<td>否</td>
<td>20000</td>
<td>集群检查时间</td>
</tr>
<tr>
<td><code>api.boot.quartz.prop.scheduler-instance-id</code></td>
<td>否</td>
<td>AUTO</td>
<td>调度器ID</td>
</tr>
<tr>
<td><code>api.boot.quartz.prop.scheduler-instance-name</code></td>
<td>否</td>
<td>jobScheduler</td>
<td>调度器名称</td>
</tr>
<tr>
<td><code>api.boot.quartz.prop.job-store-table-prefix</code></td>
<td>否</td>
<td>QRTZ_</td>
<td>表结构前缀</td>
</tr>
<tr>
<td><code>api.boot.quartz.prop.job-store-clustered</code></td>
<td>否</td>
<td>true</td>
<td>是否开启任务数据集群</td>
</tr>
<tr>
<td><code>api.boot.quartz.prop.job-store-driver-delegate-class</code></td>
<td>否</td>
<td>org.quartz.impl.jdbcjobstore.StdJDBCDelegate</td>
<td>任务数据源驱动类</td>
</tr>
<tr>
<td><code>api.boot.quartz.prop.thread-pool-threads-inherit-context-class-loader-of-initializing-thread</code></td>
<td>否</td>
<td>true</td>
<td>线程继承上下文类加载或定义线程</td>
</tr>
</tbody>
</table>
<h2>内存方式</h2>
<p><code>ApiBoot Quartz</code>在使用内存方式存储任务时，不需要做配置调整。</p>
<h2>数据库方式</h2>
<p>需要在<code>application.yml</code>配置文件内修改<code>api.boot.quartz.job-store-type</code>参数，如下所示：</p>
<pre><code class="language-yaml"><span class="hljs-attr">api:</span>
<span class="hljs-attr">  boot:</span>
<span class="hljs-attr">    quartz:</span>
      <span class="hljs-comment"># Jdbc方式</span>
<span class="hljs-attr">      job-store-type:</span> <span class="hljs-string">jdbc</span>
</code></pre>
<h3>Quartz所需表结构</h3>
<p><code>Quartz</code>的数据库方式内部通过<code>DataSource</code>获取数据库连接对象来进行操作数据，所操作数据表的表结构是固定的，<code>ApiBoot</code>把<code>Quartz</code>所支持的所有表结构都进行了整理，访问<a href="https://github.com/hengboy/api-boot/tree/master/api-boot-samples/api-boot-sample-quartz/src/main/resources/schemas">Quartz支持数据库建表语句列表</a>查看，复制执行对应数据库语句即可。</p>
<h2>创建任务类</h2>
<p>我们只需要让新建类集成<code>QuartzJobBean</code>就可以完成创建一个任务类，如下简单示例：</p>
<pre><code class="language-java"><span class="hljs-comment">/**
 * 任务定义示例
 * 与Quartz使用方法一致，ApiBoot只是在原生基础上进行扩展，不影响原生使用
 * &lt;p&gt;
 * 继承QuartzJobBean抽象类后会在项目启动时会自动加入Spring IOC
 *
 * <span class="hljs-doctag">@author</span>：恒宇少年 - 于起宇
 * &lt;p&gt;
 * DateTime：2019-03-28 17:26
 * Blog：http://blog.yuqiyu.com
 * WebSite：http://www.jianshu.com/u/092df3f77bca
 * Gitee：https://gitee.com/hengboy
 * GitHub：https://github.com/hengboy
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DemoJob</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">QuartzJobBean</span> </span>{
    <span class="hljs-comment">/**
     * logger instance
     */</span>
    <span class="hljs-keyword">static</span> Logger logger = LoggerFactory.getLogger(DemoJob.class);

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">executeInternal</span><span class="hljs-params">(JobExecutionContext context)</span> <span class="hljs-keyword">throws</span> JobExecutionException </span>{
        logger.info(<span class="hljs-string">"定时任务Job Key ： {}"</span>, context.getJobDetail().getKey());
        logger.info(<span class="hljs-string">"定时任务执行时所携带的参数：{}"</span>, JSON.toJSONString(context.getJobDetail().getJobDataMap()));
        <span class="hljs-comment">//...处理逻辑</span>
    }
}
</code></pre>
<h3>任务参数</h3>
<p>在任务执行时传递参数是必须的，<code>ApiBoot Quartz</code>提供了比较方便的传递方式，不过最终<code>Quartz</code>会把传递的值都会转换为<code>String</code>类型数据。</p>
<h3>任务Key默认值</h3>
<p><code>ApiBoot Quartz</code>的<code>newJob</code>方法所创建的定时任务，如果在不传递<code>Job Key</code>参数时，会默认使用<code>UUID</code>随机字符串作为<code>Job Key</code>以及<code>Trigger Key</code>。</p>
<h3>自定义任务开始时间</h3>
<p>任务开始时间可以通过<code>startAtTime</code>方法进行设置，在不设置的情况下，任务创建完成后会立刻执行。</p>
<h3>Cron 表达式任务</h3>
<p>创建<code>Cron</code>类型任务如下所示：</p>
<pre><code class="language-java">String jobKey = apiBootQuartzService.newJob(ApiBootCronJobWrapper.Context()
                        .jobClass(DemoJob.class)
                        .cron(<span class="hljs-string">"0/5 * * * * ?"</span>)
                        .param(
                                ApiBootJobParamWrapper.wrapper().put(<span class="hljs-string">"param"</span>, <span class="hljs-string">"测试"</span>))
                        .wrapper());
</code></pre>
<p>Cron 表达式任务由<code>ApiBootCronJobWrapper</code>类进行构建。</p>
<p>上面的<code>DemoJob</code>任务类将会每隔<code>5秒</code>执行一次。</p>
<h3>Loop 重复任务</h3>
<p><code>Loop</code>循环任务，当在不传递重复执行次数时，不进行重复执行，仅仅执行一次，如下所示：</p>
<pre><code class="language-java">String jobKey = apiBootQuartzService.newJob(
                ApiBootLoopJobWrapper.Context()
                        <span class="hljs-comment">// 参数</span>
                        .param(
                                ApiBootJobParamWrapper.wrapper()
                                        .put(<span class="hljs-string">"userName"</span>, <span class="hljs-string">"恒宇少年"</span>)
                                        .put(<span class="hljs-string">"userAge"</span>, <span class="hljs-number">24</span>)
                        )
                        <span class="hljs-comment">// 每次循环的间隔时间，单位：毫秒</span>
                        .loopIntervalTime(<span class="hljs-number">2000</span>)
                        <span class="hljs-comment">// 循环次数</span>
                        .repeatTimes(<span class="hljs-number">5</span>)
                        <span class="hljs-comment">// 开始时间，10秒后执行</span>
                        .startAtTime(<span class="hljs-keyword">new</span> Date(System.currentTimeMillis() + <span class="hljs-number">10000</span>))
                        <span class="hljs-comment">// 任务类</span>
                        .jobClass(DemoJob.class)
                        .wrapper()
        );
</code></pre>
<p>Loop 任务由<code>ApiBootLoopJobWrapper</code>类进行构建。</p>
<p>上面的定时任务将会重复执行<code>5次</code>，连上自身执行的一次也就是会执行<code>6次</code>，每次的间隔时间为<code>2秒</code>，在任务创建<code>10秒</code>后进行执行。</p>
<h3>Once 一次性任务</h3>
<p><code>Once</code>一次性任务，任务执行一次会就会被自动释放，如下所示：</p>
<pre><code class="language-java">
Map paramMap = <span class="hljs-keyword">new</span> HashMap(<span class="hljs-number">1</span>);
paramMap.put(<span class="hljs-string">"paramKey"</span>, <span class="hljs-string">"参数值"</span>);

String jobKey = apiBootQuartzService.newJob(
  ApiBootOnceJobWrapper.Context()
  .jobClass(DemoJob.class)
  <span class="hljs-comment">// 参数</span>
  .param(
    ApiBootJobParamWrapper.wrapper()
    .put(<span class="hljs-string">"mapJson"</span>, JSON.toJSONString(paramMap))
  )
  <span class="hljs-comment">// 开始时间，2秒后执行</span>
  .startAtTime(<span class="hljs-keyword">new</span> Date(System.currentTimeMillis() + <span class="hljs-number">2000</span>))
  .wrapper()
);

</code></pre>
<p>Once 任务由<code>ApiBootOnceJobWrapper</code>类进行构建。</p>
<p>在参数传递时可以是对象、集合，不过需要进行转换成字符串才可以进行使用。</p>
<h2>暂停任务执行</h2>
<p>任务在执行过程中可以进行暂停操作，通过<code>ApiBoot Quartz</code>提供的<code>pauseJob</code>方法就可以很简单的实现，当然暂停时需要传递<code>Job Key</code>，<code>Job Key</code>可以从创建任务方法返回值获得。</p>
<p>暂停任务如下所示：</p>
<pre><code class="language-java"><span class="hljs-comment">// 暂停指定Job Key的任务</span>
apiBootQuartzService.pauseJob(jobKey);
<span class="hljs-comment">// 暂停多个执行中任务</span>
apiBootQuartzService.pauseJobs(jobKey,jobKey,jobKey);
</code></pre>
<h2>恢复任务执行</h2>
<p>任务执行完暂停后，如果想要恢复可以使用如下方式：</p>
<pre><code class="language-java"><span class="hljs-comment">// 恢复指定Job Key的任务执行</span>
apiBootQuartzService.resumeJob(jobKey);
<span class="hljs-comment">// 恢复多个暂停任务</span>
apiBootQuartzService.resumeJobs(jobKey,jobKey,jobKey);
</code></pre>
<h2>修改Cron表达式</h2>
<p>修改<code>Cron</code>表达式的场景如下：</p>
<ul>
<li>已创建 &amp; 未执行</li>
<li>已创建 &amp; 已执行</li>
</ul>
<p>修改方法如下所示：</p>
<pre><code class="language-java"><span class="hljs-comment">// 修改执行Job Key任务的Cron表达式</span>
apiBootQuartzService.updateJobCron(jobKey, <span class="hljs-string">"0/5 * * * * ?"</span>);
</code></pre>
<h2>删除任务</h2>
<p>想要手动释放任务时可以使用如下方式：</p>
<pre><code class="language-java"><span class="hljs-comment">// 手动删除指定Job Key任务</span>
apiBootQuartzService.deleteJob(jobKey);
<span class="hljs-comment">// 手动删除多个任务</span>
apiBootQuartzService.deleteJobs(jobKey,jobKey,jobKey);
</code></pre>
<p>删除任务的顺序如下：</p>
<ol>
<li>暂停触发器</li>
<li>移除触发器</li>
<li>删除任务</li>
</ol>
</div></section><footer class="footer-container"><div class="footer-body"><img src="/img/apiboot-gray.png"/><div class="cols-container"><div class="col col-12"><h3>愿景</h3><p>ApiBoot致力于解决快速开发接口服务、集成第三方依赖</p></div><div class="col col-6"><dl><dt>文档</dt><dd><a href="/zh-cn/docs/introduce.html" target="_self">概览</a></dd><dd><a href="/zh-cn/docs/quick-start.html" target="_self">快速开始</a></dd><dd><a href="/zh-cn/docs/faq.html" target="_self">开发者指南</a></dd></dl></div><div class="col col-6"><dl><dt>资源</dt><dd><a href="http://blog.yuqiyu.com" target="_self">作者博客</a></dd><dd><a href="http://blog.yuqiyu.com/tags/ApiBoot/" target="_self">文章专题</a></dd></dl></div></div><div class="copyright"><span>Copyright © 2019 恒宇少年 - 于起宇</span></div></div></footer></div></div>
	<script src="https://f.alicdn.com/react/15.4.1/react-with-addons.min.js"></script>
	<script src="https://f.alicdn.com/react/15.4.1/react-dom.min.js"></script>
	<script>
		window.rootPath = '';
	</script>
	<script src="/build/documentation.js"></script>
</body>

</html>